// Prisma Schema for ScrapeDgit

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum AuthProvider {
  EMAIL
  GOOGLE
  OTP
}

enum UserRole {
  USER
  ADMIN
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum EcommerceSource {
  TOKOPEDIA
  SHOPEE
  LAZADA
  BLIBLI
}

// ==================== USER & AUTH ====================

model User {
  id            String       @id @default(cuid())
  email         String       @unique
  name          String?
  passwordHash  String?
  authProvider  AuthProvider @default(EMAIL)
  role          UserRole     @default(USER)
  isVerified    Boolean      @default(false)
  avatarUrl     String?
  location      String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  sessions     Session[]
  otpCodes     OTPVerification[]
  chatSessions ChatSession[]

  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
}

model OTPVerification {
  id        String   @id @default(cuid())
  userId    String
  code      String
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
}

// ==================== CHAT & SEARCH ====================

model ChatSession {
  id               String   @id @default(cuid())
  userId           String
  title            String?
  isActive         Boolean  @default(true)
  accumulatedQuery Json?    // Accumulated ParsedQuery across conversation turns
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]
  results  SearchResult[]

  @@index([userId])
  @@index([createdAt])
}

model ChatMessage {
  id            String      @id @default(cuid())
  chatSessionId String
  role          MessageRole
  content       String      @db.Text
  parsedQuery   Json?
  createdAt     DateTime    @default(now())

  chatSession ChatSession @relation(fields: [chatSessionId], references: [id], onDelete: Cascade)

  @@index([chatSessionId])
}

model SearchResult {
  id                String          @id @default(cuid())
  chatSessionId     String
  productName       String
  price             Float
  rating            Float           @default(0)
  soldCount         Int             @default(0)
  sellerLocation    String
  imageUrl          String?
  productLink       String
  source            EcommerceSource
  priceScore        Float           @default(0)
  shippingScore     Float           @default(0)
  soldScore         Float           @default(0)
  ratingScore       Float           @default(0)
  finalScore        Float           @default(0)
  estimatedShipping Float?
  rank              Int?
  createdAt         DateTime        @default(now())

  chatSession ChatSession @relation(fields: [chatSessionId], references: [id], onDelete: Cascade)

  @@index([chatSessionId])
  @@index([finalScore])
  @@index([source])
}
